{
	"name": "SP_RVImportUrlaub",
	"properties": {
		"content": {
			"query": "DROP PROCEDURE [dbo].[SP_RVImportUrlaub]\nGO\n\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE PROC [dbo].[SP_RVImportUrlaub] @Filename VARCHAR(255), @Ladelauf_ID VARCHAR(5)\nAS\n\nDECLARE @SQLString NVARCHAR(1001)\nDECLARE @SourceFile NVARCHAR(255)\nDECLARE @ParmDefinition NVARCHAR(500)\nDECLARE @STICHTAG Date\n\nSET @SourceFile = 'https://stak8ddmpdev1processed.dfs.core.windows.net/processed/PocZeus/Regelverarbeitung/' + @Filename\n\nSET @SQLString = 'COPY INTO dbo.MART_PERSONALMENGENSTEUERUNG_URLAUBSANSPRUCH \\\n(STICHTAG,   STAMMKST,   BST_NR,   BST_NAME,   ZEUS_FUNKTION_BEZEICHNUNG,   BASISKENNZAHL_NAME,   MENGENEINHEIT,   WERTART,   BEZUGSDATUM,   WERT,   FGUELTIG_VON,   LADELAUF_ID default ' + @Ladelauf_ID + ',   FGUELTIG_BIS default ''31.12.2199'' \\\n) FROM \\\n''' + @SourceFile + ''' \\\nWITH (    FILE_TYPE = ''CSV'',\tFIELDTERMINATOR = '';'',\tFIELDQUOTE = '''' \\\n,    ENCODING = ''UTF8''   \\\n,    DATEFORMAT = ''dmy'',    FIRSTROW = 2)'  \n\nSET @ParmDefinition = ''  \nEXEC sp_executesql @SQLString\n\n/* Ermittle eingeladenen Stichtag */\nSELECT Top(1) @Stichtag=Stichtag  FROM dbo.MART_PERSONALMENGENSTEUERUNG_URLAUBSANSPRUCH WHERE Ladelauf_ID = @Ladelauf_ID\n\n/* Füge Soll Einträge hinzu */\nINSERT INTO dbo.MART_PERSONALMENGENSTEUERUNG_URLAUBSANSPRUCH\n(Stichtag, STAMMKST, BST_NR, BST_NAME,ZEUS_FUNKTION_BEZEICHNUNG, BASISKENNZAHL_NAME, MENGENEINHEIT, WERTART, BEZUGSDATUM, WERT, LADELAUF_ID, FGUELTIG_VON, FGUELTIG_BIS)\nSELECT '2021-08-31' as Stichtag, STAMMKST, BST_NR, BST_NAME,ZEUS_FUNKTION_BEZEICHNUNG, BASISKENNZAHL_NAME, MENGENEINHEIT, 'Soll' as WERTART,\ndatefromparts(Year(Stichtag)+1, Month(Stichtag), '1') as BEZUGSDATUM, WERT, 30 as LADELAUF_ID, '2021-08-31' as FGUELTIG_VON, '2199-12-31' as FGUELTIG_BIS  FROM dbo.MART_PERSONALMENGENSTEUERUNG_URLAUBSANSPRUCH\nWHERE Stichtag Between dateadd(\"mm\",-11,'2021-08-31') AND '2021-08-31'  AND WERTART='IST'\n\n/* Füge fehlende Historieneinträge hinzu */\nINSERT INTO dbo.MART_PERSONALMENGENSTEUERUNG_URLAUBSANSPRUCH\n(Stichtag, STAMMKST, BST_NR, BST_NAME, Zeus_Funktion_Bezeichnung, BASISKENNZAHL_NAME, BEZUGSDATUM, WERT, LADELAUF_ID, MENGENEINHEIT, FGUELTIG_VON, FGUELTIG_BIS, Wertart  )\nSelect '2021-08-31' as Stichtag, STAMMKST, BST_Nr, BST_NAME, Zeus_Funktion_Bezeichnung, BASISKENNZAHL_NAME, BEZUGSDATUM, 0 as WERT, 31 as LADELAUF_ID, 'Zeit [d]' as MENGENEINHEIT, '2021-08-31' as FGUELTIG_VON, '2199-12-31' as FGUELTIG_BIS, 'Soll' as Wertart \nFROM \n(\nSelect STAMMKST, BST_Nr, BST_NAME, Zeus_Funktion_Bezeichnung, BASISKENNZAHL_NAME, Table_B.Bezugsdatum\nFROM\n(\nSelect STAMMKST, BST_Nr,BST_NAME,Zeus_Funktion_Bezeichnung, BASISKENNZAHL_NAME\nfrom dbo.MART_PERSONALMENGENSTEUERUNG_URLAUBSANSPRUCH \nwhere Stichtag = '2021-08-31' and Wertart='Soll'\ngroup by STAMMKST, BST_Nr,BST_NAME,Zeus_Funktion_Bezeichnung, BASISKENNZAHL_NAME\n) Table_A\nCROSS JOIN (Select distinct(Bezugsdatum) as Bezugsdatum from dbo.MART_PERSONALMENGENSTEUERUNG_URLAUBSANSPRUCH WHERE Stichtag = '2021-08-31' and Wertart='Soll') TABLE_B\nEXCEPT\nSELECT STAMMKST, BST_Nr,BST_NAME,Zeus_Funktion_Bezeichnung, BASISKENNZAHL_NAME, Bezugsdatum  from dbo.MART_PERSONALMENGENSTEUERUNG_URLAUBSANSPRUCH \nwhere Stichtag = '2021-08-31' and Wertart='Soll'\n) Table_D\n\n/* Lösche alte Imports für den gleichen Stichtag */\nDELETE FROM dbo.MART_PERSONALMENGENSTEUERUNG_URLAUBSANSPRUCH WHERE Ladelauf_ID <> @Ladelauf_ID And Stichtag = @Stichtag",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "sqlpool1",
				"poolName": "sqlpool1"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}